<script>
  (function() {
    // Helper function to get and parse dataset gtmBody
    function getGtmBodyData(element) {
      if (!element) {
        return null;
      }
      var data = element? JSON.parse(element.dataset.gtmBody) : null;
      if (!data) {
        return null;
      }
      return data;
    }

    // Main function to handle different events
    function handleEvent(element, eventType, additionalData, modifyEvent) {
      // page
      var pageElement = document.querySelector('[data-gtm-page]');
      var pageData = getGtmBodyData(pageElement);
      if (!pageData) return;

      // section
      var sectionElement = element.closest('[data-gtm-section]');
      var sectionData = getGtmBodyData(sectionElement);

      // visibility or click
      var specificElement = element.closest('[data-gtm-' + eventType + ']');
      var specificData = getGtmBodyData(specificElement);
      if (!specificData) return;

      if (modifyEvent) {
        if (eventType == 'visibility'){
          specificData.event += '_' + 'view';
          specificData.event_name = specificData.event;
        } else {
          specificData.event += '_' + eventType;
          specificData.event_name = specificData.event;
        }
      }

      // Combine data
      var combinedData = Object.assign({}, pageData, sectionData, specificData, additionalData);

      // Push to dataLayer
      console.log(eventType);
      console.log(combinedData);
      dataLayer.push(combinedData);

      return combinedData;
    }

    window._gtm = {
      getGtmBodyData: getGtmBodyData,
      handleEvent: handleEvent
    };
  })();
</script>
