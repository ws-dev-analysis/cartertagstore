<script>
  (function() {
    // Helper function to get and parse dataset gtmBody
    function getGtmBodyData(element) {
      if (!element) {
        return null;
      }
      var data = element ? JSON.parse(element.dataset.gtmBody) : null;
      if (!data) {
        return null;
      }
      return data;
    }

    // Main function to handle different events
    function handleEvent(element, eventType) {
      // page
      var pageElement = document.querySelector('[data-gtm-page]');
      var pageData = getGtmBodyData(pageElement);
      if (!pageData) return;

      // section
      var sectionElement = element.closest('[data-gtm-section]');
      var sectionData = getGtmBodyData(sectionElement) || {};

      // Add event to sectionData based on isPopup value
      var isPopup = sectionData.isPopup;
      var eventSuffix = eventType === 'visibility' ? 'view' : eventType;

      // visibility or click
      var eventElement = element.closest('[data-gtm-' + eventType + ']');
      var eventData = getGtmBodyData(eventElement);
      if (!eventData) return;

      // Combine data into the desired structure
      var combinedData = {
        event: (isPopup ? 'popup_' : 'cts_') + eventSuffix,
        pageData: pageData,
        sectionData: sectionData,
        eventData: eventData
      };

      // Push to dataLayer
      console.log(eventType);
      console.log(combinedData);
      dataLayer.push(combinedData);

      return combinedData;
    }

    window._gtm = {
      getGtmBodyData: getGtmBodyData,
      handleEvent: handleEvent
    };
  })();
</script>
