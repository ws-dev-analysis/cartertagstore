<script>
  (function() {
    // Helper function to get and parse dataset gtmBody
    function getGtmBodyData(element) {
      if (!element) {
        return null;
      }
      var data = element ? JSON.parse(element.dataset.gtmBody) : null;
      if (!data) {
        return null;
      }
      return data;
    }

    // page-title depth parser
    function parsePageTitle(title) {
      var parts = title.split('>');
      var depth = {};

      // Assigning depths based on the given requirements
      depth['1depth'] = parts[0] || '';
      depth['2depth'] = parts[1] || '';
      depth['3depth'] = parts[2] || '';
      depth['4depth'] = parts[3] || '';

      // Joining the remaining parts for 5depth and beyond
      if (parts.length > 4) {
        depth['5depth'] = parts.slice(4).join('>');
      } else {
        depth['5depth'] = '';
      }

      return depth;
    }

    // Main function to handle different events
    function handleEvent(element, eventType) {
      // page
      var pageElement = document.querySelector('[data-gtm-page]');
      var pageData = getGtmBodyData(pageElement);
      var depthData = parsePageTitle(pageData.page_title);
      pageData = Object.assign({}, pageData, depthData);
      if (!pageData) return;

      // section
      var sectionElement = element.closest('[data-gtm-section]');
      var sectionData = getGtmBodyData(sectionElement) || {};

      // Add event to sectionData based on isPopup value
      var isPopup = sectionData.isPopup;
      var eventSuffix = eventType === 'visibility' ? 'view' : eventType;

      // visibility or click
      var eventElement = element.closest('[data-gtm-' + eventType + ']');
      var eventData = getGtmBodyData(eventElement);
      if (!eventData) return;

      // Combine data into the desired structure
      var combinedData = {
        event: (isPopup ? 'popup_' : 'cts_') + eventSuffix,
        pageData: pageData,
        sectionData: sectionData,
        eventData: eventData
      };

      // Push to dataLayer
      console.log(eventType);
      console.log(combinedData);
      dataLayer.push(combinedData);

      return combinedData;
    }

    window._gtm = {
      getGtmBodyData: getGtmBodyData,
      handleEvent: handleEvent
    };
  })();
</script>
